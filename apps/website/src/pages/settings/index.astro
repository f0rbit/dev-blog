---
import SettingsPage from "@/components/settings/settings-page";
import AppLayout from "@/layouts/app-layout.astro";
import { api } from "@/lib/api";
import type { AccessKey, User } from "@blog/schema";

type Token = Pick<AccessKey, "id" | "name" | "note" | "enabled" | "created_at">;

let user: User | null = null;
let tokens: Token[] = [];

try {
	const runtime = Astro.locals.runtime;
	const [userRes, tokensRes] = await Promise.all([api.ssr("/auth/status", Astro.request, {}, runtime), api.ssr("/api/blog/tokens", Astro.request, {}, runtime)]);

	if (userRes.ok) {
		const data = await userRes.json();
		if (data.authenticated) {
			user = data.user;
		}
	}

	if (tokensRes.ok) {
		const data = await tokensRes.json();
		tokens = data.tokens ?? [];
	}
} catch (e) {
	// Settings fetch failed silently
}
---

<AppLayout title="Settings">
	<section class="flex-col">
		<header>
			<h1 class="page-title">Settings</h1>
		</header>
		<SettingsPage client:load initialUser={user} initialTokens={tokens} />
	</section>
</AppLayout>
