---
import SettingsPage from "@/components/settings/settings-page";
import AppLayout from "@/layouts/app-layout.astro";
import { api } from "@/lib/api";

interface User {
	id: number;
	github_id: number;
	username: string;
	email: string | null;
	avatar_url: string | null;
	created_at: string;
	updated_at: string;
}

interface Token {
	id: number;
	name: string;
	note?: string;
	enabled: boolean;
	created_at: string;
}

let user: User | null = null;
let tokens: Token[] = [];

try {
	const runtime = Astro.locals.runtime;
	const [userRes, tokensRes] = await Promise.all([api.ssr("/auth/status", Astro.request, {}, runtime), api.ssr("/api/blog/tokens", Astro.request, {}, runtime)]);

	if (userRes.ok) {
		const data = await userRes.json();
		if (data.authenticated) {
			user = data.user;
		}
	}

	if (tokensRes.ok) {
		const data = await tokensRes.json();
		tokens = data.tokens ?? [];
	}
} catch (e) {
	// Settings fetch failed silently
}
---

<AppLayout title="Settings">
	<section class="flex-col">
		<header>
			<h1 class="page-title">Settings</h1>
		</header>
		<SettingsPage client:load initialUser={user} initialTokens={tokens} />
	</section>
</AppLayout>
