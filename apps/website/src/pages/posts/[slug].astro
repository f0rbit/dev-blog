---
import PostEditor from "@/components/post/post-editor";
import AppLayout from "@/layouts/app-layout.astro";
import { api } from "@/lib/api";

const { slug } = Astro.params;

type Category = {
	name: string;
	parent: string | null;
};

type CategoryNode = Category & { children?: CategoryNode[] };

type Post = {
	id: number;
	uuid: string;
	slug: string;
	title: string;
	content: string;
	description?: string;
	format: "md" | "adoc";
	category: string;
	tags: string[];
	project_ids: string[];
	publish_at: string | null;
	updated_at: string;
};

const flattenTree = (nodes: CategoryNode[]): Category[] => nodes.flatMap(n => [{ name: n.name, parent: n.parent }, ...flattenTree(n.children ?? [])]);

// Fetch post and categories server-side
let post: Post | null = null;
let categories: Category[] = [];
let error: string | null = null;

console.log("[SSR] Fetching post with slug:", slug);
console.log("[SSR] API URL:", api.blog(`/post/${slug}`));

try {
	const [postRes, catRes] = await Promise.all([api.ssr(`/api/blog/post/${slug}`, Astro.request), api.ssr("/api/blog/categories", Astro.request)]);

	console.log("[SSR] Post response status:", postRes.status);
	console.log("[SSR] Categories response status:", catRes.status);

	if (postRes.ok) {
		post = await postRes.json();
		console.log("[SSR] Post data:", JSON.stringify(post, null, 2));
	} else {
		const errorText = await postRes.text();
		console.log("[SSR] Post fetch failed:", errorText);
		error = "Post not found";
	}

	if (catRes.ok) {
		const catData = await catRes.json();
		console.log("[SSR] Raw categories:", JSON.stringify(catData, null, 2));
		categories = flattenTree(catData.categories ?? []);
		console.log("[SSR] Flattened categories:", JSON.stringify(categories, null, 2));
	}
} catch (e) {
	console.log("[SSR] Fetch error:", e);
	error = "Failed to load post";
}

console.log("[SSR] Final post:", post?.title);
console.log("[SSR] Final categories count:", categories.length);
console.log("[SSR] Final error:", error);
---

<AppLayout title="Edit Post">
	<section class="flex-col">
		<header>
			<h1 class="page-title flex-row">
				<a href="/posts" title="Back to posts" class="back-arrow">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
				</a>
				Edit Post
			</h1>
			{post && <button type="button" id="save-btn" class="btn-primary" disabled>Update</button>}
		</header>

		{error ? (
			<div class="form-error">{error}</div>
		) : post ? (
			<div id="editor-container" data-uuid={post.uuid}>
				<PostEditor client:load post={post} categories={categories} onFormReady={() => {}} />
			</div>
		) : (
			<div class="form-error">Post not found</div>
		)}
	</section>
</AppLayout>

<style>
	.back-arrow {
		display: flex;
		align-items: center;
		color: var(--text-muted);
	}
	.back-arrow:hover {
		color: var(--text-link);
	}
</style>

<script define:vars={{ API_BASE: api.blog("") }}>
	const API_URL = API_BASE;

	type PostFormData = {
		slug: string;
		title: string;
		content: string;
		description?: string;
		format: "md" | "adoc";
		category: string;
		tags: string[];
		project_ids: string[];
		publish_at: Date | null;
	};

	const handleSave = async (uuid: string, data: PostFormData) => {
		const response = await fetch(`${API_URL}/post/${uuid}`, {
			method: "PUT",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
				slug: data.slug,
				title: data.title,
				content: data.content,
				description: data.description,
				format: data.format,
				category: data.category,
				tags: data.tags,
				project_ids: data.project_ids,
				publish_at: data.publish_at?.toISOString() ?? null,
			}),
		});

		if (!response.ok) {
			const error = await response.json().catch(() => ({ message: "Unknown error" }));
			throw new Error(error.message ?? "Failed to update post");
		}

		const post = await response.json();
		if (post.slug !== data.slug) {
			window.location.href = `/posts/${post.slug}`;
		}
	};

	// Wire up save button once PostEditor is ready
	document.addEventListener("DOMContentLoaded", () => {
		const saveBtn = document.getElementById("save-btn") as HTMLButtonElement | null;
		const container = document.getElementById("editor-container");
		if (!saveBtn || !container) return;

		const uuid = container.dataset.uuid;
		if (!uuid) return;

		// PostEditor will call window.postEditorReady when form is ready
		(window as any).postEditorReady = (getFormData: () => PostFormData) => {
			saveBtn.disabled = false;

			saveBtn.addEventListener("click", async () => {
				const data = getFormData();
				if (!data.title.trim()) {
					alert("Title is required");
					return;
				}
				if (!data.slug.trim()) {
					alert("Slug is required");
					return;
				}

				saveBtn.disabled = true;
				saveBtn.textContent = "Saving...";

				try {
					await handleSave(uuid, data);
					saveBtn.textContent = "Update";
				} catch (e) {
					alert(e instanceof Error ? e.message : "Failed to save");
					saveBtn.textContent = "Update";
				} finally {
					saveBtn.disabled = false;
				}
			});
		};
	});
</script>
