---
import AppLayout from "@/layouts/app-layout.astro";
import { api } from "@/lib/api";
import { relativeTime } from "@/lib/date-utils";
import type { Post } from "@blog/schema";

const formatProjectId = (id: string): string => id.replace(/^proj[-_]/, "").replace(/[-_]/g, " ");

let posts: Post[] = [];
let error: string | null = null;

try {
	const runtime = Astro.locals.runtime;
	const response = await api.ssr("/api/blog/posts?limit=100", Astro.request, {}, runtime);

	if (!response.ok) {
		throw new Error("Failed to fetch posts");
	}
	const data = await response.json();
	posts = data.posts ?? [];
} catch (err) {
	error = "Failed to load posts";
}
---

<AppLayout title="Posts">
  <section class="flex-col">
    <header>
      <h1 class="page-title">Posts</h1>
      <a href="/posts/new" class="btn-primary">New Post</a>
    </header>

    <div id="posts-container">
      {error ? (
        <div class="form-error">{error}</div>
      ) : posts.length === 0 ? (
        <div class="empty-state">
          <p>No posts yet.</p>
          <a href="/posts/new" class="btn-primary">Create your first post</a>
        </div>
      ) : (
        <div class="posts-grid">
          {posts.map((post) => {
            const dateStr = post.publish_at ?? post.updated_at;
            return (
              <div class="post-card">
                <a href={`/posts/${post.slug}`} class="post-card__link">
                  <span class="post-card__title">{post.title}</span>
                  {post.description && <p class="post-card__description">{post.description}</p>}
                </a>
                {post.project_ids.length > 0 && (
                  <div class="post-card__projects">
                    {post.project_ids.map(id => (
                      <span class="post-card__project">{formatProjectId(id)}</span>
                    ))}
                  </div>
                )}
                <div class="post-card__footer">
                  <span class="post-card__meta">
                    <span class="post-card__category">{post.category}</span>
                    <span class="post-card__date">{relativeTime(dateStr)}</span>
                  </span>
                  <a href={`/posts/${post.uuid}/versions`} class="post-card__history">History</a>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  </section>
</AppLayout>
