---
import AppLayout from "@/layouts/app-layout.astro";

type Post = {
  uuid: string;
  slug: string;
  title: string;
  description?: string;
  category: string;
  tags: string[];
  publish_at: string | null;
  updated_at: string;
  project_ids: string[];
};

const formatProjectId = (id: string): string => 
  id.replace(/^proj[-_]/, "").replace(/[-_]/g, " ");

const relativeTime = (dateStr: string): string => {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffSeconds = Math.floor(diffMs / 1000);
  const diffMinutes = Math.floor(diffSeconds / 60);
  const diffHours = Math.floor(diffMinutes / 60);
  const diffDays = Math.floor(diffHours / 24);
  const diffWeeks = Math.floor(diffDays / 7);
  const diffMonths = Math.floor(diffDays / 30);

  if (diffSeconds < 60) return "just now";
  if (diffMinutes < 60) return diffMinutes === 1 ? "1 minute ago" : `${diffMinutes} minutes ago`;
  if (diffHours < 24) return diffHours === 1 ? "1 hour ago" : `${diffHours} hours ago`;
  if (diffDays < 7) return diffDays === 1 ? "1 day ago" : `${diffDays} days ago`;
  if (diffWeeks < 4) return diffWeeks === 1 ? "1 week ago" : `${diffWeeks} weeks ago`;
  return diffMonths === 1 ? "1 month ago" : `${diffMonths} months ago`;
};

let posts: Post[] = [];
let error: string | null = null;

try {
  const response = await fetch("http://localhost:8080/posts?limit=100");
  if (!response.ok) throw new Error("Failed to fetch posts");
  const data = await response.json();
  posts = data.posts ?? [];
} catch (err) {
  error = "Failed to load posts";
}
---

<AppLayout title="Posts">
  <section class="flex-col">
    <header>
      <h1 class="page-title">Posts</h1>
      <a href="/posts/new" class="btn-primary">New Post</a>
    </header>

    <div id="posts-container">
      {error ? (
        <div class="form-error">{error}</div>
      ) : posts.length === 0 ? (
        <div class="empty-state">
          <p>No posts yet.</p>
          <a href="/posts/new" class="btn-primary">Create your first post</a>
        </div>
      ) : (
        <div class="posts-grid">
          {posts.map((post) => {
            const dateStr = post.publish_at ?? post.updated_at;
            return (
              <div class="post-card">
                <a href={`/posts/${post.slug}`} class="post-card__link">
                  <span class="post-card__title">{post.title}</span>
                  {post.description && <p class="post-card__description">{post.description}</p>}
                </a>
                {post.project_ids.length > 0 && (
                  <div class="post-card__projects">
                    {post.project_ids.map(id => (
                      <span class="post-card__project">{formatProjectId(id)}</span>
                    ))}
                  </div>
                )}
                <div class="post-card__footer">
                  <span class="post-card__meta">
                    <span class="post-card__category">{post.category}</span>
                    <span class="post-card__date">{relativeTime(dateStr)}</span>
                  </span>
                  <a href={`/posts/${post.uuid}/versions`} class="post-card__history">History</a>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  </section>
</AppLayout>
