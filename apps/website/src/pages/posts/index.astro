---
import AppLayout from "@/layouts/app-layout.astro";
---

<AppLayout title="Posts">
  <section class="flex-col">
    <header>
      <h1 class="page-title">Posts</h1>
      <a href="/posts/new" class="btn-primary">New Post</a>
    </header>

    <div id="posts-container">
      <div id="posts-grid" class="posts-grid">
        <p class="muted">Loading posts...</p>
      </div>

      <div id="empty-state" class="empty-state hidden">
        <p>No posts yet.</p>
        <a href="/posts/new" class="btn-primary">Create your first post</a>
      </div>
    </div>
  </section>
</AppLayout>

<script>
  const API_URL = "http://localhost:8080";

  type Post = {
    slug: string;
    title: string;
    description?: string;
    category: string;
    tags: string[];
    publish_at: string | null;
    updated_at: string;
  };

  const deriveStatus = (publishAt: string | null): "draft" | "scheduled" | "published" => {
    if (!publishAt) return "draft";
    const publishDate = new Date(publishAt);
    return publishDate <= new Date() ? "published" : "scheduled";
  };

  const formatDate = (dateStr: string): string => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
    });
  };

  const renderPosts = (posts: Post[]) => {
    const gridEl = document.getElementById("posts-grid");
    const emptyStateEl = document.getElementById("empty-state");
    if (!gridEl || !emptyStateEl) return;

    if (posts.length === 0) {
      gridEl.classList.add("hidden");
      emptyStateEl.classList.remove("hidden");
      return;
    }

    emptyStateEl.classList.add("hidden");
    gridEl.classList.remove("hidden");

    gridEl.innerHTML = posts
      .map(post => {
        const status = deriveStatus(post.publish_at);
        return `
          <a href="/posts/${post.slug}" class="post-card">
            <div class="post-card__header">
              <span class="post-card__title">${post.title}</span>
              <span class="status-badge status-badge--${status}">${status}</span>
            </div>
            <p class="post-card__meta">
              <span>${post.category}</span>
              <span>Â·</span>
              <span>${formatDate(post.updated_at)}</span>
            </p>
          </a>
        `;
      })
      .join("");
  };

  const fetchPosts = async () => {
    try {
      const response = await fetch(`${API_URL}/posts?limit=100`);
      if (!response.ok) throw new Error("Failed to fetch posts");

      const data = await response.json();
      const posts: Post[] = data.posts ?? [];
      renderPosts(posts);
    } catch (err) {
      const gridEl = document.getElementById("posts-grid");
      if (gridEl) {
        gridEl.innerHTML = `<div class="form-error">Failed to load posts</div>`;
      }
    }
  };

  document.addEventListener("DOMContentLoaded", fetchPosts);
</script>

<style>
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .post-card {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    border: 1px solid var(--input-border);
    border-radius: 4px;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.15s;
  }

  .post-card:hover {
    border-color: var(--text-muted);
    text-decoration: none;
  }

  .post-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
  }

  .post-card__title {
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .post-card__meta {
    display: flex;
    gap: 6px;
    font-size: 0.75rem;
    color: var(--text-muted);
  }
</style>
