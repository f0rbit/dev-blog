name: Preview Deployment

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Run tests
        run: bun test
      
      - name: Build frontend
        run: bun run build:client
        env:
          PUBLIC_API_URL: https://blog-devpad-api-preview.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev
      
      - name: Deploy Worker (Preview)
        run: bunx wrangler deploy --env preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Deploy Pages (Preview)
        id: pages-deploy
        run: |
          OUTPUT=$(bunx wrangler pages deploy apps/website/dist --project-name=blog-devpad --branch=${{ github.head_ref || github.ref_name }})
          echo "$OUTPUT"
          URL=$(echo "$OUTPUT" | grep -o 'https://[^ ]*\.pages\.dev' | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Comment PR with preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.pages-deploy.outputs.url }}';
            if (url) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Preview Deployment\n\nðŸš€ Preview deployed to: ${url}\n\n**API**: https://blog-devpad-api-preview.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev`
              });
            }
